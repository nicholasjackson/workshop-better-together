# Step 2: Update Existing Terraform to Deploy New Secure Packer Image with AAP provider

With the Minecraft server image built, it's time to deploy it using Terraform. But bewareâ€”the final gateway to the treasure remains locked. Only by configuring Terraform to integrate with Ansible can you prove your worth and gain access!

# 1. Essential Details for Deployment
Before making any changes, take note of the essential machine details and AAP credentials:

## Machine Name
```
{{ machine_url }}
```
## Ansible Automation Platform
```bash
https://44.210.128.10
```
Go to <a href="https://44.210.128.10" target="_blank">Ansible Automation Platform</a>
```bash
username: <team_name>_admin
Ansible Automation password:{{ ansible_pass }}
```
# 2. Prepare Your Terraform Configuration
Now, let's configure Terraform to deploy the new image and integrate with AAP.

<Task id="update_terraform">
## Update your existing terraform configuration to use the new packer image
### copy files from aap directory to the terraform directory
In this task we are updating the existing Terraform configuration to use the 
new packer image and apply user access using the AAP provider.
The additional required to integrate the AAP provider is already provided in the aap directory,
copy the contents to your Terraform directory.


The AAP provider allows application teams to directly manage their application inventory and can coexist with dynamic inventories that may be managed using cloud metadata.
We use the Ansible Automation Platform **ansible/aap** provider to perform the following tasks. 

* create an inventory in your AAP organization
* create a host in the inventory amd assign the ansible_host and ansible_port
* execute an existing job template passing in as a variable your minecraft username to allow access to a the minecraft server

see code snippert below:
```hcl
# Create a new AAP inventory for the your minecraft server
resource "aap_inventory" "dedicated_minecraft" {
  name = "minecraft_dedicated"
  description = "Dedicated Minecraft Server"
  organization = local.org_id
}

# Create a new AAP host for the minecraft server
resource "aap_host" "vm_hosts" {
  inventory_id = aap_inventory.dedicated_minecraft.id
  name         = var.minecraft_hostname  # Use the hostname for each VM
  variables    = jsonencode({
    "ansible_host"     : "${var.minecraft_hostname}",
    "ansible_port"     : var.ansible_port
})
}

resource "aap_job" "minecraft_whitelist" {
  job_template_id = local.template_id
  inventory_id    = aap_inventory.dedicated_minecraft.id
  extra_vars      = jsonencode({
    "minecraft_usernames" : var.minecraft_usernames
  })

  triggers = {
    "${var.minecraft_hostname}" : "${var.trigger_run}"
  }
  
}
```


Before proceeding ensure your in the terraform directory from the terminal

```bash
# ensure your in the terraform directory
cp ../aap/* .
ls
```
confirm the files are copied
```bash
root@debian:/workshop/src/working/terraform# ls
aap.tf  main.tf providers.tf  terraform.auto.tfvars
root@debian:/workshop/src/working/terraform# 
```

</Task>



# 3. Update Terraform Variables and Validate Terraform
<Task id="terraform_validate">
update the terraform.auto.tfvars using cli or vscode, or if 
your more comfortable with vscode you can use that from the workshop tab.

![vscode-terraform](https://dl.dropbox.com/scl/fi/zq9xbve7g8pp7c50bfcwd/vscode-terraform.png?rlkey=z64crgxgndh7hsnz54m3nliyu&st=myh94xd7&dl=0)
Alternatively you can follow the steps below to use the CLI.

```bash
vi terraform.auto.tfvars
```

```bash
# terraform.auto.tfvars
aap_username="<team_name>_admin" replace <team_name> with your team name
aap_password="" # AAP password {{ ansible_pass }} see the docs at the top of the task page
minecraft_hostname="" # your minecraft hostname is {{ machine_url }}
minecraft_usernames=[] # update with your minecraft usernames in > ["user1","user2"]
image_source="/var/workshop/images/minecraft_vm_ansible/minecraft-vm-ansible.qcow2"
```
save the updates

```bash
esc :wq
```

validate the terraform configuration updates

```bash
terraform init
terraform validate
```

once you have validated the terraform configuration, 
you can run terraform plan to review the changes.

```bash
terraform plan
```

see example output below

```
root@debian:/workshop/src/working/terraform# terraform plan
data.http.minecraft_accesslist: Reading...
data.http.minecraft_accesslist: Read complete after 1s [
  id=https://44.210.128.100/api/controller/v2/job_templates/?name=minecraft_whitelist]

Terraform used the selected providers to generate the following execution plan. 
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # aap_host.vm_hosts will be created
...
...
  # libvirt_volume.ubuntu-qcow2 will be created
  + resource "libvirt_volume" "ubuntu-qcow2" {
      + format = (known after apply)
      + id     = (known after apply)
      + name   = "ubuntu-qcow2"
      + pool   = "ubuntu"
      + size   = (known after apply)
      + source = "/var/workshop/images/minecraft_vm_ansible/minecraft-vm-ansible.qcow2"
    }

Plan: 7 to add, 0 to change, 0 to destroy.

Changes to Outputs:
  + ip_address    = "192.168.16.100"
  + socat_command = "socat TCP-LISTEN:25565,fork,reuseaddr TCP:192.168.16.100:25565"
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Note: You didn't use the -out option to save this plan, 
so Terraform can't guarantee to take exactly these actions if you run "terraform apply" now.
```

</Task>
 
# 4. Deploy Terraform

<Task id="terraform_apply">
apply the changes
```
terraform apply
```
confirm apply by typing yes

see example run below 
```
  Enter a value: yes

libvirt_network.minecraft: Creating...
libvirt_pool.ubuntu: Creating...
libvirt_pool.ubuntu: Creation complete after 0s [id=267dcea0-e95e-45d5-957c-24c30602d529]
libvirt_volume.ubuntu-qcow2: Creating...
libvirt_network.minecraft: Creation complete after 0s [id=ae0aa162-528d-4ec2-9556-fcd0000d4131]
aap_inventory.dedicated_minecraft: Creating...
libvirt_volume.ubuntu-qcow2: Still creating... [10s elapsed]
```
</Task>

# 5. Connect Minecraft Server
<Task id="connect_minecraft">
Using your Minecraft client connect to the Minecraft server using the DNS address provided.
```
{{ machine_url }}
```
</Task>

# 6.Validate Your Deployment in Minecraft
Now that your Minecraft server is up and running, itâ€™s time to test your deployment!

a. Launch Minecraft and connect to your deployed server using the machine name:
```
minecraft.container.local.jmpd.in
```
b. Enter the world and check the environment:
* Confirm that the server is accessible.
* Verify that the spawn point is correct.
* Ensure that your custom settings from Ansible & Terraform were applied.

c. Test User Access Permissions:
* If you set specific users in Terraform, check if they can join and interact.
* Try to break/place blocks if survival mode is enabled.
* Ensure only the whitelisted users can connect.

d. Solve the Hidden Coordinates Puzzle:
* Look at the Terraform output from Step 5.
* It contains mysterious coordinates â€“ go there in Minecraft!
* At the location, you will find a hidden sign with a secret message.
* Note down this message â€“ youâ€™ll need it for the final challenge.

ðŸš€ Once you have validated the server and solved the puzzle, youâ€™ve completed Task 3!



